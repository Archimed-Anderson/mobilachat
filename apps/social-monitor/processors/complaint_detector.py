"""
D√©tecteur de r√©clamations pour les posts Mastodon
"""
import re
from typing import Dict, Any, List, Tuple
import logging

logger = logging.getLogger(__name__)


class ComplaintDetector:
    def __init__(self):
        # Mots-cl√©s de r√©clamation
        self.complaint_keywords = [
            "nul", "nulle", "horrible", "terrible", "catastrophe", "d√©sastre",
            "mauvais", "mal", "malheureux", "d√©√ßu", "d√©cevant", "frustrant",
            "√©nervant", "agac√©", "f√¢ch√©", "en col√®re", "furieux", "exasp√©r√©",
            "d√©go√ªt√©", "r√©volt√©", "scandalis√©", "indign√©", "outr√©",
            "probl√®me", "bug", "erreur", "dysfonctionnement", "panne",
            "plainte", "r√©clamation", "r√©mun√©ration", "d√©dommagement"
        ]
        
        # Emojis n√©gatifs
        self.negative_emojis = [
            "üò†", "üò°", "ü§¨", "üò§", "üòû", "üò¢", "üò≠", "üëé", "‚ùå", "üíî", "üòí",
            "ü§Æ", "ü§¢", "üò§", "üò†", "üò°", "ü§¨", "üò§", "üòû", "üò¢", "üò≠"
        ]
        
        # Patterns de r√©clamation
        self.complaint_patterns = [
            r"je.*suis.*d√©√ßu",
            r"c'est.*nul",
            r"√ßa.*marche.*pas",
            r"service.*client.*nul",
            r"free.*mobile.*nul",
            r"jamais.*plus.*free",
            r"je.*vais.*changer",
            r"r√©silier.*contrat",
            r"plainte.*contre",
            r"r√©clamation.*free"
        ]
        
        # Mots d'intensification
        self.intensifiers = [
            "tr√®s", "vraiment", "extr√™mement", "totalement", "compl√®tement",
            "absolument", "carr√©ment", "franchement", "s√©rieusement"
        ]
        
        # Mots de n√©gation
        self.negations = [
            "pas", "ne", "n'", "jamais", "rien", "aucun", "nul", "nulle"
        ]
    
    def detect_complaint(self, content: str) -> Dict[str, Any]:
        """D√©tecte si un post est une r√©clamation"""
        try:
            content_lower = content.lower()
            
            # Calcul du score de r√©clamation
            complaint_score = self._calculate_complaint_score(content_lower)
            
            # D√©tection des mots-cl√©s
            found_keywords = self._find_complaint_keywords(content_lower)
            
            # D√©tection des patterns
            found_patterns = self._find_complaint_patterns(content_lower)
            
            # D√©tection des emojis n√©gatifs
            negative_emoji_count = self._count_negative_emojis(content)
            
            # D√©tection de la n√©gation
            has_negation = self._has_negation(content_lower)
            
            # Calcul de l'urgence
            urgency = self._calculate_urgency(
                complaint_score, 
                negative_emoji_count, 
                len(found_keywords),
                len(found_patterns)
            )
            
            # D√©termination du type de r√©clamation
            complaint_type = self._classify_complaint_type(content_lower, found_keywords)
            
            # Calcul de la confiance
            confidence = min(complaint_score / 10.0, 1.0)
            
            return {
                "is_complaint": complaint_score >= 3.0,
                "complaint_score": complaint_score,
                "confidence": confidence,
                "urgency": urgency,
                "type": complaint_type,
                "keywords_found": found_keywords,
                "patterns_found": found_patterns,
                "negative_emoji_count": negative_emoji_count,
                "has_negation": has_negation,
                "sentiment": self._analyze_sentiment(content_lower, complaint_score)
            }
            
        except Exception as e:
            logger.error(f"Erreur lors de la d√©tection de r√©clamation: {e}")
            return {
                "is_complaint": False,
                "complaint_score": 0.0,
                "confidence": 0.0,
                "urgency": "low",
                "type": "unknown",
                "keywords_found": [],
                "patterns_found": [],
                "negative_emoji_count": 0,
                "has_negation": False,
                "sentiment": "neutral"
            }
    
    def _calculate_complaint_score(self, content: str) -> float:
        """Calcule le score de r√©clamation"""
        score = 0.0
        
        # Score des mots-cl√©s
        for keyword in self.complaint_keywords:
            if keyword in content:
                score += 1.0
                # Bonus pour les mots-cl√©s forts
                if keyword in ["nul", "horrible", "terrible", "catastrophe"]:
                    score += 0.5
        
        # Score des patterns
        for pattern in self.complaint_patterns:
            if re.search(pattern, content):
                score += 2.0
        
        # Score des emojis n√©gatifs
        emoji_count = self._count_negative_emojis(content)
        score += emoji_count * 0.5
        
        # Bonus pour la r√©p√©tition
        for keyword in self.complaint_keywords:
            count = content.count(keyword)
            if count > 1:
                score += (count - 1) * 0.3
        
        # Bonus pour les majuscules (cri)
        caps_ratio = sum(1 for c in content if c.isupper()) / len(content) if content else 0
        if caps_ratio > 0.3:
            score += 1.0
        
        # Bonus pour les points d'exclamation
        exclamation_count = content.count('!')
        score += exclamation_count * 0.2
        
        return score
    
    def _find_complaint_keywords(self, content: str) -> List[str]:
        """Trouve les mots-cl√©s de r√©clamation dans le contenu"""
        found_keywords = []
        for keyword in self.complaint_keywords:
            if keyword in content:
                found_keywords.append(keyword)
        return found_keywords
    
    def _find_complaint_patterns(self, content: str) -> List[str]:
        """Trouve les patterns de r√©clamation dans le contenu"""
        found_patterns = []
        for pattern in self.complaint_patterns:
            if re.search(pattern, content):
                found_patterns.append(pattern)
        return found_patterns
    
    def _count_negative_emojis(self, content: str) -> int:
        """Compte les emojis n√©gatifs dans le contenu"""
        count = 0
        for emoji in self.negative_emojis:
            count += content.count(emoji)
        return count
    
    def _has_negation(self, content: str) -> bool:
        """D√©tecte la pr√©sence de n√©gations"""
        for negation in self.negations:
            if negation in content:
                return True
        return False
    
    def _calculate_urgency(
        self, 
        complaint_score: float, 
        emoji_count: int, 
        keyword_count: int, 
        pattern_count: int
    ) -> str:
        """Calcule le niveau d'urgence"""
        urgency_score = complaint_score + (emoji_count * 0.5) + (keyword_count * 0.3) + (pattern_count * 0.5)
        
        if urgency_score >= 8:
            return "urgent"
        elif urgency_score >= 5:
            return "high"
        elif urgency_score >= 3:
            return "medium"
        else:
            return "low"
    
    def _classify_complaint_type(self, content: str, keywords: List[str]) -> str:
        """Classifie le type de r√©clamation"""
        # Facturation
        billing_keywords = ["facture", "facturation", "paiement", "pr√©l√®vement", "co√ªt", "prix"]
        if any(keyword in content for keyword in billing_keywords):
            return "billing"
        
        # Technique
        tech_keywords = ["probl√®me", "bug", "erreur", "connexion", "r√©seau", "signal", "wifi"]
        if any(keyword in content for keyword in tech_keywords):
            return "technical"
        
        # Service client
        service_keywords = ["service", "client", "support", "aide", "r√©ponse", "attente"]
        if any(keyword in content for keyword in service_keywords):
            return "customer_service"
        
        # R√©siliation
        cancellation_keywords = ["r√©silier", "annuler", "arr√™ter", "changer", "op√©rateur"]
        if any(keyword in content for keyword in cancellation_keywords):
            return "cancellation"
        
        # G√©n√©ral
        return "general"
    
    def _analyze_sentiment(self, content: str, complaint_score: float) -> str:
        """Analyse le sentiment du contenu"""
        if complaint_score >= 5:
            return "very_negative"
        elif complaint_score >= 3:
            return "negative"
        elif complaint_score >= 1:
            return "slightly_negative"
        else:
            return "neutral"
    
    def get_complaint_examples(self) -> List[Dict[str, str]]:
        """Retourne des exemples de r√©clamations"""
        return [
            {
                "content": "Free Mobile c'est nul, √ßa marche jamais !",
                "type": "technical",
                "urgency": "high"
            },
            {
                "content": "Je suis d√©√ßu de Free Mobile, service client inexistant",
                "type": "customer_service",
                "urgency": "medium"
            },
            {
                "content": "Ma facture Free Mobile est trop ch√®re, je vais r√©silier",
                "type": "billing",
                "urgency": "high"
            },
            {
                "content": "Probl√®me de connexion Free Mobile depuis 3 jours",
                "type": "technical",
                "urgency": "medium"
            }
        ]
    
    def get_detection_stats(self, posts: List[Dict[str, Any]]) -> Dict[str, Any]:
        """Calcule les statistiques de d√©tection sur une liste de posts"""
        if not posts:
            return {"total": 0, "complaints": 0, "complaint_rate": 0.0}
        
        total_posts = len(posts)
        complaint_count = 0
        urgency_counts = {"low": 0, "medium": 0, "high": 0, "urgent": 0}
        type_counts = {}
        
        for post in posts:
            result = self.detect_complaint(post.get("content", ""))
            if result["is_complaint"]:
                complaint_count += 1
                urgency_counts[result["urgency"]] += 1
                complaint_type = result["type"]
                type_counts[complaint_type] = type_counts.get(complaint_type, 0) + 1
        
        return {
            "total": total_posts,
            "complaints": complaint_count,
            "complaint_rate": (complaint_count / total_posts) * 100 if total_posts > 0 else 0,
            "urgency_distribution": urgency_counts,
            "type_distribution": type_counts
        }


